---
title: '**Название исследования**'
author: "Выполнил(и): "
output:
  html_document:
    number_sections: true
    code_folding: hide
    toc: true
    toc_float: true
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
data <- readxl::read_excel("data./HW_data.xlsx")
```
```{r}
library(psych)
library(flextable)
library(dplyr)
library(tidyverse)
library(purrr)
library(ggplot2)
```
<br>

# **Постановка задачи**

Исследователь изучает влияние курения матери во время беременности на вес ребенка при рождении и на развитие осложнений во время родов.
Мы это поняли как то, что исследователь хочет найти величину эффекта курения на массу тела ребенка при рождении И на развитие осложнений (отдельно).
Чем будет полезен ответ на этот вопрос: степень настороженности врача роддома при приеме на роды курящей матери, профилактические меры: например, принятие решения о профилактическом введении какого-либо препарата, более длительное наблюдение.
Масса тела ребенка при рождении - это все-таки суррогатный признак развития осложнений у ребенка (медиатор?) то есть если мать курит, то у ребенка могут быть осложнения / пороки развития, которые проявляются через низкую массу тела.

<br>

Для решения задачи будет использована каузальная, а не предсказательная модель, поскольку нас интересует не предсказание исхода (массы тела ребенка при рождении и развитие осложнений), а **оценка воздействия** (курения матери) на исход. Предсказательная модель не позволит оценить конфаундинг (смешивающие факторы) и интерпретировать результаты как каузальные, тем более, с ее помощью мы можем получить смещенную оценку.

<br>

Возможные систематические ошибки:

- Смещение из-за конфаундеров - влияние других факторов как на воздействие (курение матери), так и исход (вес ребенка при рождении и развитие осложнений во время родов), что может искажать оценку. Представленные в данных переменные будут поделены на *воздействие, исход, конфаундеры, коллайдеры, медиаторы и нейтральные переменные* и включены / не включены в модель.

- Смещение из-за неучтенных конфаундеров - останется нерешенным. Например, стресс и плохое питание могут сами по себе негативно влиять на вес ребенка при рождении и на развитие осложнений во время родов и при этом быть ассоциированы с курением матери. Из-за этого полученная нами оценка может быть завышена. 

- Так как информация о курении собиралась со слов матерей (кросс-секционное исследование), она может быть неточной - матери могут недоговаривать правду, поскольку курение во время беременности считается социально неодобряемым поведением; мы не можем решить эту ошибку. Это может занизить влияние курения на вес ребенка и осложнения.

- Selection Bias - курящие матери с осложнениями при родах могут отказываться от участия в исследовании опять же из-за неодобрения общества и чувства вины, поэтому оценка негативного влияния курения может быть занижена; мы также не в силах решить эту ошибку.

<br>

Если бы мы могли предотвратить или скорректировать все предполагаемые систематические ошибки, то мы бы ожидали наблюдать статистически значимое снижение среднего веса при рождении у детей, а также повышение вероятности осложнений во время родов у матерей, которые курили во время беременности. 

<br>

*Снижение веса*

Существуют исследования, показавшие ассоциацию между курением матери и весом ребенка при рождении. Так, в 1957 Simpson отметил, что новорожденные у курящих матерей (10 и больше сигарет в день) в среднем весили на 200 г меньше. В исследовании Butler и коллег (1972) было показано, что курение матерей (в частности, на 4 месяце беременности) было связано с повышением внутриутробной и перинатальной смертности, а также снижением веса ребенка в среднем на 170 г. Kramer провел мета-анализ исследований 1970-1984 гг. и обнаружил, что в среднем вес детей курящих матерей оказался меньше на 149 г, а также подсчитал, что каждая выкуренная в день сигарета снижала общую массу тела ребенка при рождении на 11.1 г.

Что касается биологических причин данного явления, снижение веса можно объяснить окислительным и генотоксическим стрессом, которому подвергаются клетки плода при действии никотина и других компонентов табачного дыма, которые проходят через плацентарный барьер и задерживаются в амниотической жидкости. Было показано, что у детей с мутациями в генах, отвечающих за защиту от окислительного стресса (ферменты системы глутатиона), снижение веса было еще больше, вплоть до 262 г (Aagaard-Tillery K, 2010). Также, известно, что никотин вызывает сужение кровеносных сосудов (включая сосуды матки и плаценты), что ограничивает приток крови к плоду, поставку кислорода и важных питательных веществ, в то же время задерживая токсичные продукты метаболизма в тканях плода. Монооксид углерода, поступающий в кровь при курении, имеет большее сродство к гемоглобину и образует карбоксигемоглобин, вытесняя кислород, что приводит к хронической внутриутробной гипоксии (кислородному голоданию).

<br>

*Осложнения во время родов*

Показано, что курение во время беременности ассоциировано с такими осложнениями, как предлежание плаценты, отслойка плаценты, преждевременный разрыв плодных оболочек, задержка роста плода и синдром внезапной детской смерти (Robert L. Andres, 2000). Причины осложнений у курящих женщин могут включать множество факторов, таких как кислородное голодание тканей матки, плаценты и плода и недостаток питательных веществ (описано выше), пониженное количество коллагена 3 типа (Hadley C, 1990), воспаление плаценты и пуповины (Naeye R, 1978), подверженность бактериальным и вирусным инфекциям (снижение иммунного статуса), в целом вызванных токсическим действием никотина, продуктов его обмена (котинин), и других компонентов табачного дыма.

<br>

# **Материалы и методы**

## **Дизайн исследования**

...

<br>

## **Конечные точки**

...

<br>

## **Описательные статистики**

Для описания количественных переменных использовали среднее ± стандартное отклонение (СО), минимум и максимум, для описания качественных переменных - количество и %. 
Масса тела визуализирована при помощи box-plot, а % осложнений - в виде столбчатой диаграммы. 

### Демографические и социально-экономические характеристики
Нами получены данные из случайной выборки (n=537) из когоры детей, родившихся в США в 1990 г. 
Средний возраст матери составил 26,32 (±5,77) лет (с минимумом 15 лет и максимумом 43 года).Раса большинства женщин была white (76%), более половины женщин были не замужем (74,67%). Что касается образования, 37,8 % участниц окончили колледж, 56,8% - High School и лишь 5,4% - Elementary School. Описательная статистика по демографическим и социально-экономическим характеристикам представлена представлена в разделе 3.1 

<br> 

### Зависимости 
Среди 537 женщин 81,94% женщин не курили, 98,88% не употребляли алкоголь. Среднее количество сигарет/сут среди курящих составило 13,42 (± 6,79) с минимумом 1 и максимумом 30. Среднее количество дринков среди тех, кто употреблял алкоголь, составило 2,83 (±1,72) с минимумом 1 и максимумом 6.Описательная статистика по зависимостям представлена в разделе 3.1

<br> 

### Осложнения со стороны матери и плода 
Все 537 случаев родов были ассоциированы с какими-либо пороками развития у младенцев (100% случаев). При этом осложнения в родах перенесли 67,23% женщин. Зафиксирован один случай смерти новорожденного (0,19%).Описательная статистика по осложнениям представлена в разделе 3.1. 

<br> 

### Эффект курения
Среди 440 некурящих женщин средняя масса тела их ребенка составила 3407.79 ± 570.46 г,а среди 97 курящих женщин - 3179.66 ± 552.93 г. Что касается осложнений в родах, среди курящих и не курящих матерей осложнения в родах перенесли приблизительно 67%. Описательная статистика по эффекту курения на количественные и качественные переменные представлена в разделе 3.1.
Масса тела плода при рождении у некурящих и курящих матерей и осложнения в родах у некурящих и курящих матерей пердставлены на рисунках ниже. 


```{r}
ggplot(data, aes(x = tobacco, y = dbirwt)) +
  geom_boxplot(fill = "lightblue") +
  theme_minimal() +
  labs(
    title = "Масса тела плода при рождении у некурящих и курящих матерей",
    x = "Курение 0-нет, 1-да",
    y = "Масса тела плода при рождении, г"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )


```
```{r}
ggplot(data, aes(x = labor, fill = tobacco)) +
  geom_bar(aes(y = after_stat(count / sum(count))), 
           position = "fill", alpha = 0.7) +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  labs(
    title = "Осложнения в родах у некурящих и курящих матерей",
    x = "Курение 0-нет, 1-да",
    y = "Осложнения в родах, %"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```



```{r}


```

<br>

## **Анализ конечной точки 1**

### **Описание модели**

...

<br>

### **DAG и отбор ковариат для модели**

**Деление переменных:**  
Воздействие - Mothers smoking
Исход - Birth weight
Конфаундеры - Mothers education, Mothers alcohol drinking, Mothers race, Mothers Age, prenatal care и medical risk, который не является прямым предком воздействия а реализует свой путь через prenatal care.
Коллайдеры - Infant death и Complications of labor/delivery
Медиаторы - нет 
Нейтральные переменные - Childs sex, delivery method, number of previous deliveries

**Итоговый набор для деконфаудинга:** Mothers education, Mothers alcohol drinking, Mothers race, Mothers Age, prenatal care

**Примечания:** Можно было включить в модель и, но контролируя prenatal care мы тем самым блокируем и back-door путь для medical risk (возможно поэтому DAGitty в своём наборе его и не предлагает).
Можно было также сконтролировать нейтральный переменные (Childs sex, delivery method, number of previous deliveries), которые не зависимо от того, учитываются ли они в модели или нет, они не открывают и не закрывают никаких back-door путей, так как они все являются предшественниками исхода их контролирование может снижать вариацию остатков модели => уменьшая тем самым стандартную ошибку и повышая точность оценки.
Мы их, тем не менее, решили не включать, чтобы не повышать количество переменных в модели и не столкнуться с усилением смещения.

После проведения эксплораторного анализа были выявлены статистически значимые линейные взаимосвязи между некоторыми независимыми переменными. В частности, обнаружена умеренная положительная корреляция между возрастом и образованием матери (r = 0.385) и умеренная отрицательная корреляция между возрастом матери и количеством родов (r = -0.335). Кроме того, визуальный анализ указывает на возможные ассоциации между количеством родов и употреблением алкоголя, а также между количеством сигарет и употреблением алкоголя.

Таким образом, в дальнейшей работе планируется рассмотреть возможность исключения переменных "образование матери/Mothers education". Для окончательного решения необходимо количественно оценить этот риск. Также планируется оценить возможность исключения переменной "употребление алкоголя/Mothers alcohol drinking", целесообразно провести анализ чувствительности, сравнив модели с этой переменной и без нее.

...

<br>

### **Измерение ключевых показателей**

...

<br>

### **Формат представления результатов**

...

<br>

## **Анализ конечной точки 2**

### **Описание модели**

...

<br>

### **DAG и отбор ковариат для модели**

**Деление переменных:** Воздействие - Mothers smoking
Исход - Complications of labor/delivery
Конфаундеры - Mothers education, Mothers alcohol drinking, Mothers race, Mothers Age, prenatal care,
medical risk, который не является прямым наследников воздействия а реализует свой путь через prenatal care.
Коллайдеры - Infant death
Медиаторы - Birth weight  
Нейтральные переменные - Childs sex, delivery method, number of previous deliveries

**Итоговый набор для деконфаудинга:** Mothers education, Mothers alcohol drinking, Mothers race, Mothers Age, prenatal care

**Примечания:** Здесь, в целом, похожая ситуация, но можно было еще сконтролировать Childs sex, которых, хоть не является прямым предком исхода, но его кнтроль будет иметь аналогичный эффект как и для предущей ситуцаии, потому что он все равно реализует свое воздействие на исход через медиатор => его включение может снижать вариацию остатков модели => уменьшать стандартную ошибку и повышать точность оценки. Мы его тоже решили не включать, чтобы не повышать количество переменных в модели.
Аналогичная ситуация с Mothers education и Mothers alcohol drinking, для которых палнируется провести анализ чувствительности и количественную оценку риска.



```{r}

```


...

<br>

### **Измерение ключевых показателей**

...

<br>

### **Формат представления результатов**

...

<br>

## **Анализ дополнительных конечных точек**

...

<br>

# **3 Результаты**

## **3.1 Описательная статистика и эксплораторный анализ**

### Демография и социально-экономический статус 
```{r}
demo1 <- data %>%
  select(dmage) %>%
  describe() %>%
  as.data.frame() %>%
  select(vars, n, mean, sd, min, max) %>%
  mutate(across(c(mean, sd, min, max), ~round(., 2))) %>%
  mutate(
    Variable = as.character(vars), 
    Category = "Mean (SD)",
    percent = NA
  ) %>%
  select(-vars) 

demo2 <- c("mrace3", "dmar", "dmeduc3")
freq_table2 <- map_dfr(demo2, ~{
  data %>%
    count(!!sym(.x)) %>%
    mutate(
      percent = round(n / sum(n) * 100, 2),
      Variable = as.character(.x),
      Category = as.character(!!sym(.x)),
      mean = NA, sd = NA, min = NA, max = NA
    ) %>%
    select(Variable, Category, n, mean, sd, min, max, percent)
})

final_table <- bind_rows(demo1, freq_table2) %>%
  select(Variable, Category, n, percent, mean, sd, min, max)

final_table_rus <- final_table %>%
  rename(
    'Переменная' = Variable,
    'Категория' = Category,
    'Количество' = n,
    'Процент' = percent,
    'Среднее' = mean,
    'Ст. отклонение' = sd,
    'Минимум' = min,
    'Максимум' = max
  ) %>%
  mutate(
    Категория = case_when(
      Категория == "Mean (SD)" ~ "Среднее (СО)",
      TRUE ~ Категория
    ),
    Переменная = case_when(
      Переменная == "dmage" ~ "Возраст матери",
      Переменная == "mrace3" ~ "Раса",
      Переменная == "dmar" ~ "Семейное положение", 
      Переменная == "dmeduc3" ~ "Образование матери",
      TRUE ~ Переменная
    )
  )

final_table_rus <- final_table_rus %>%
  group_by(Переменная) %>%
  mutate(Переменная = ifelse(row_number() == 1, Переменная, "")) %>%
  ungroup()


ft <- flextable(final_table_rus) %>%
  theme_box() %>%
  autofit()
ft
```
### Зависимости 
...

```{r}
data %>% summary()
```
=======
```{r}
smoke_quant <- data %>%
  summarise(
    cigar_n = sum(!is.na(cigar) & tobacco == 1),
    cigar_mean = mean(cigar[tobacco == 1], na.rm = TRUE),
    cigar_sd = sd(cigar[tobacco == 1], na.rm = TRUE),
    cigar_min = min(cigar[tobacco == 1], na.rm = TRUE),
    cigar_max = max(cigar[tobacco == 1], na.rm = TRUE),
    
    drink_n = sum(!is.na(drink) & alcohol == 1),
    drink_mean = mean(drink[alcohol == 1], na.rm = TRUE),
    drink_sd = sd(drink[alcohol == 1], na.rm = TRUE),
    drink_min = min(drink[alcohol == 1], na.rm = TRUE),
    drink_max = max(drink[alcohol == 1], na.rm = TRUE)
  ) %>%
  pivot_longer(
    everything(),
    names_to = c("Variable", "stat"),
    names_sep = "_",
    values_to = "value"
  ) %>%
  pivot_wider(
    names_from = "stat",
    values_from = "value"
  ) %>%
  mutate(
    across(c(mean, sd, min, max), ~round(., 2)),
    Category = "Mean (SD)",
    percent = NA
  ) %>%
  select(Variable, Category, n, percent, mean, sd, min, max)

smoke_qual <- c("tobacco", "alcohol")
freq_table_smoke <- map_dfr(smoke_qual, ~{
  data %>%
    count(!!sym(.x)) %>%
    mutate(
      percent = round(n / sum(n) * 100, 2),
      Variable = as.character(.x),
      Category = as.character(!!sym(.x)),
      mean = NA, sd = NA, min = NA, max = NA
    ) %>%
    select(Variable, Category, n, mean, sd, min, max, percent)
})

smoke_final_table <- bind_rows(smoke_quant, freq_table_smoke) %>%
  select(Variable, Category, n, percent, mean, sd, min, max)

smoke_final_table_rus <- smoke_final_table %>%
  rename(
    'Переменная' = Variable,
    'Категория' = Category,
    'Количество' = n,
    'Процент' = percent,
    'Среднее' = mean,
    'Ст. отклонение' = sd,
    'Минимум' = min,
    'Максимум' = max
  ) %>%
  mutate(
    Категория = case_when(
      Категория == "Mean (SD)" ~ "Среднее (СО)",
      Категория == "0" ~ "Нет",
      Категория == "1" ~ "Да",
      TRUE ~ Категория
    ),
    Переменная = case_when(
      Переменная == "tobacco" ~ "Курение",
      Переменная == "cigar" ~ "Сигарет в день (среди курящих)",
      Переменная == "alcohol" ~ "Употребление алкоголя", 
      Переменная == "drink" ~ "Дринков в день (среди пьющих)",
      TRUE ~ Переменная
    )
  )

smoke_final_table_rus <- smoke_final_table_rus %>%
  group_by(Переменная) %>%
  mutate(Переменная = ifelse(row_number() == 1, Переменная, "")) %>%
  ungroup()

ft_smoke <- flextable(smoke_final_table_rus) %>%
  theme_box() %>%
  autofit()

ft_smoke
```
### Осложнения со стороны матери и плода 
```{r}

complications_qual <- c("labor", "newborn", "congenit", "death")
freq_table_complications <- map_dfr(complications_qual, ~{
  data %>%
    count(!!sym(.x)) %>%
    mutate(
      percent = round(n / sum(n) * 100, 2),
      Variable = as.character(.x),
      Category = as.character(!!sym(.x))
    ) %>%
    select(Variable, Category, n, percent)
})

complications_final_table_rus <- freq_table_complications %>%
  rename(
    'Переменная' = Variable,
    'Категория' = Category,
    'Количество' = n,
    'Процент' = percent
  ) %>%
  mutate(
    Категория = case_when(
      Категория == "0" ~ "Нет",
      Категория == "1" ~ "Да",
      TRUE ~ Категория
    ),
    Переменная = case_when(
      Переменная == "labor" ~ "Осложнения в родах",
      Переменная == "newborn" ~ "Аномальные состояния новорожденного", 
      Переменная == "congenit" ~ "Врожденные аномалии",
      Переменная == "death" ~ "Смертность",
      TRUE ~ Переменная
    )
  )


complications_final_table_rus <- complications_final_table_rus %>%
  group_by(Переменная) %>%
  mutate(Переменная = ifelse(row_number() == 1, Переменная, "")) %>%
  ungroup()

ft_complications <- flextable(complications_final_table_rus) %>%
  theme_box() %>%
  autofit()

ft_complications
```
### Эффект курения 
```{r}

quantitative_vars <- c("dmage", "dmeduc", "dtotord", "dlivord", "monpre", "cigar", "drink", 
                      "nprevist", "gestat", "dbirwt", "aged")

quant_table <- map_dfr(quantitative_vars, ~{
  data %>%
    group_by(tobacco) %>%
    summarise(
      n = sum(!is.na(!!sym(.x))),
      mean = round(mean(!!sym(.x), na.rm = TRUE), 2),
      sd = round(sd(!!sym(.x), na.rm = TRUE), 2),
      .groups = 'drop'
    ) %>%
    mutate(
      tobacco_group = ifelse(tobacco == 0, "Некурящие", "Курящие"),
      value = paste0(mean, " ± ", sd),
      Variable = .x
    ) %>%
    select(Variable, tobacco_group, n, value)
}) %>%
  pivot_wider(
    names_from = tobacco_group,
    values_from = c(n, value),
    names_sep = "_"
  ) %>%
  mutate(
    Variable = case_when(
      Variable == "dmage" ~ "Возраст матери (лет)",
      Variable == "dmeduc" ~ "Образование матери (лет)",
      Variable == "dtotord" ~ "Количество родов",
      Variable == "dlivord" ~ "Количество родов живым плодом",
      Variable == "monpre" ~ "Месяц постановки на учет",
      Variable == "cigar" ~ "Количество сигарет в день",
      Variable == "drink" ~ "Количество дринков в день",
      Variable == "nprevist" ~ "Количество визитов при наблюдении беременности",
      Variable == "gestat" ~ "Гестационный возраст (недели)",
      Variable == "dbirwt" ~ "Вес при рождении (граммы)",
      Variable == "aged" ~ "Возраст при смерти (дни)",
      TRUE ~ Variable
    )
  ) %>%
  select(
    Переменная = Variable,
    `N_некурящие` = n_Некурящие,
    `Значение_некурящие` = value_Некурящие,
    `N_курящие` = n_Курящие,
    `Значение_курящие` = value_Курящие
  )

ft_quant <- flextable(quant_table) %>%
  theme_box() %>%
  autofit()
ft_quant


qualitative_vars <- c("mrace3", "dmar", "dmeduc3", "adequacy", "medrisk", 
                     "alcohol", "pldel", "delmeth", "csex", "labor", 
                     "newborn", "congenit", "death")

create_qual_table <- function(var_name) {
  data %>%
    group_by(tobacco, !!sym(var_name)) %>%
    summarise(n = n(), .groups = 'drop') %>%
    group_by(tobacco) %>%
    mutate(percent = round(n / sum(n) * 100, 2)) %>%
    ungroup() %>%
    mutate(
      tobacco_group = ifelse(tobacco == 0, "Некурящие", "Курящие"),
      category = as.character(!!sym(var_name)),
      Variable = var_name
    ) %>%
    select(Variable, category, tobacco_group, n, percent)
}

qual_table <- map_dfr(qualitative_vars, create_qual_table) %>%
  pivot_wider(
    names_from = tobacco_group,
    values_from = c(n, percent),
    names_sep = "_"
  ) %>%
  mutate(
    `Некурящие` = ifelse(is.na(n_Некурящие), "0", 
                        paste0(n_Некурящие, " (", percent_Некурящие, "%)")),
    `Курящие` = ifelse(is.na(n_Курящие), "0", 
                      paste0(n_Курящие, " (", percent_Курящие, "%)"))
  ) %>%
  mutate(
    Variable = case_when(
      Variable == "mrace3" ~ "Раса",
      Variable == "dmar" ~ "Замужество",
      Variable == "dmeduc3" ~ "Образование",
      Variable == "adequacy" ~ "Адекватность наблюдения",
      Variable == "medrisk" ~ "Медицинские факторы риска",
      Variable == "alcohol" ~ "Употребление алкоголя",
      Variable == "pldel" ~ "Место родов",
      Variable == "delmeth" ~ "Метод родоразрешения",
      Variable == "csex" ~ "Пол ребенка",
      Variable == "labor" ~ "Осложнения в родах",
      Variable == "newborn" ~ "Аномалии новорожденного",
      Variable == "congenit" ~ "Врожденные аномалии",
      Variable == "death" ~ "Смертность",
      TRUE ~ Variable
    ),
    category = case_when(
      category == "0" ~ "Нет",
      category == "1" ~ "Да",
      TRUE ~ category
    )
  ) %>%
  select(
    Переменная = Variable,
    Категория = category,
    Некурящие,
    Курящие
  )

qual_table_final <- qual_table %>%
  group_by(Переменная) %>%
  mutate(Переменная = ifelse(row_number() == 1, Переменная, "")) %>%
  ungroup()


ft_qual <- flextable(qual_table_final) %>%
  theme_box() %>%
  autofit()
ft_qual
```

>>>>>>> bf37fb1ca901c53af87e64d5a77655bb7e9787be
...

<br>

## **Результаты анализа конечной точки 1**

...

```{r}

```

...

<br>

## **Результаты анализа конечной точки 2**

...

```{r}

```

...

<br>

## **Результаты анализа дополнительных конечных точек**

...

```{r}

```

...

<br>

# **Ограничения**

...

<br>

# **Выводы**

...

<br>

# **Использование ИИ**

...

<br>

# **Приложения**

## **Приложение 1**

```{r}

```

<br>

## **Приложение 2**

```{r}

```

<br>

## **Приложение N**

```{r}

```
